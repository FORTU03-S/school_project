{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg p-4 mb-5 bg-white rounded">
        <h1 class="card-title text-center mb-4 text-primary">{{ title }}</h1>

        {% if messages %}
            <div class="mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
            </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100 border-primary">
                        <div class="card-header bg-primary text-white py-3">
                            <h5 class="mb-0"><i class="bi bi-person-fill"></i> Informations de l'Élève</h5>
                        </div>
                        <div class="card-body">
                            {% for field in student_form %}
                                <div class="mb-3">
                                    {{ field.label_tag }}
                                    {{ field|add_class:"form-control" }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                            {% if student_form.non_field_errors %}
                                {% for error in student_form.non_field_errors %}
                                    <div class="alert alert-danger mt-3">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 border-info">
                        <div class="card-header bg-info text-white py-3">
                            <h5 class="mb-0"><i class="bi bi-people-fill"></i> Gestion du Parent</h5>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs mb-3" id="parentTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link {% if active_tab == 'create_new' or not active_tab %}active{% endif %}" id="create-new-tab" data-bs-toggle="tab" data-bs-target="#create-new" type="button" role="tab" aria-controls="create-new" aria-selected="{% if active_tab == 'create_new' or not active_tab %}true{% else %}false{% endif %}">Créer un Nouveau Parent</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link {% if active_tab == 'select_existing' %}active{% endif %}" id="select-existing-tab" data-bs-toggle="tab" data-bs-target="#select-existing" type="button" role="tab" aria-controls="select-existing" aria-selected="{% if active_tab == 'select_existing' %}true{% else %}false{% endif %}">Sélectionner Parent Existant</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="parentTabContent">
                                {# Contenu pour Créer un Nouveau Parent #}
                                <div class="tab-pane fade {% if active_tab == 'create_new' or not active_tab %}show active{% endif %}" id="create-new" role="tabpanel" aria-labelledby="create-new-tab">
                                    <p class="text-muted">Remplissez les informations pour créer un nouveau compte parent.</p>
                                    {% for field in parent_creation_form %}
                                        <div class="mb-3">
                                            {{ field.label_tag }}
                                            {{ field|add_class:"form-control" }}
                                            {% if field.help_text %}
                                                <small class="form-text text-muted">{{ field.help_text }}</small>
                                            {% endif %}
                                            {% for error in field.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endfor %}
                                    {% if parent_creation_form.non_field_errors %}
                                        {% for error in parent_creation_form.non_field_errors %}
                                            <div class="alert alert-danger mt-3">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                {# Contenu pour Sélectionner un Parent Existant avec Autocomplete #}
                                <div class="tab-pane fade {% if active_tab == 'select_existing' %}show active{% endif %}" id="select-existing" role="tabpanel" aria-labelledby="select-existing-tab">
                                    <p class="text-muted">Recherchez et choisissez un parent déjà enregistré.</p>
                                    <div class="mb-3">
                                        <label for="id_existing_parent-parent_search_term" class="form-label">Rechercher un Parent</label>
                                        <input type="text" id="id_existing_parent-parent_search_term" name="existing_parent-parent_search_term" class="form-control" placeholder="Nom, Prénom ou Email du parent">
                                        <div id="parent-suggestions" class="list-group position-absolute w-100 z-index-1000" style="max-height: 200px; overflow-y: auto;">
                                            {# Suggestions seront injectées ici par JavaScript #}
                                        </div>
                                        {# Champ caché pour stocker l'ID du parent sélectionné #}
                                        <input type="hidden" id="id_existing_parent-parent_id" name="existing_parent-parent_id">
                                        {% if existing_parent_form.parent_id.errors %}
                                            {% for error in existing_parent_form.parent_id.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    {% if existing_parent_form.non_field_errors %}
                                        {% for error in existing_parent_form.non_field_errors %}
                                            <div class="alert alert-danger mt-3">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            <input type="hidden" name="action_type" id="action_type_input" value="{{ active_tab|default:'create_new' }}">
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-plus-circle-fill"></i> Ajouter Élève et Parent</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const createNewTabBtn = document.getElementById('create-new-tab');
        const selectExistingTabBtn = document.getElementById('select-existing-tab');
        const actionTypeInput = document.getElementById('action_type_input');

        // --- Éléments pour la recherche de parent AJAX ---
        const parentSearchInput = document.getElementById('id_existing_parent-parent_search_term');
        const parentSuggestionsDiv = document.getElementById('parent-suggestions');
        const parentIdInput = document.getElementById('id_existing_parent-parent_id');
        let searchTimeout = null;
        // Le CSRF_TOKEN est correctement récupéré
        const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;
        // L'URL est correctement générée par Django
        const PARENT_SEARCH_URL = "{% url 'profiles:search_parents_ajax' %}";

        // Mettre à jour le champ caché 'action_type' en fonction de l'onglet actif
        createNewTabBtn.addEventListener('shown.bs.tab', function (event) {
            actionTypeInput.value = 'create_new';
            toggleRequiredFields('new_parent', true);
            toggleRequiredFields('existing_parent', false);
        });

        selectExistingTabBtn.addEventListener('shown.bs.tab', function (event) {
            actionTypeInput.value = 'select_existing';
            toggleRequiredFields('new_parent', false);
            toggleRequiredFields('existing_parent', true);
            // Cacher les suggestions quand l'onglet change
            parentSuggestionsDiv.innerHTML = '';
            parentSuggestionsDiv.style.display = 'none';
            // Réinitialiser l'input de recherche et l'ID du parent quand on change d'onglet
            parentSearchInput.value = '';
            parentIdInput.value = '';
        });

        function toggleRequiredFields(prefix, isRequired) {
            const formContainer = document.getElementById(prefix === 'new_parent' ? 'create-new' : 'select-existing');
            if (formContainer) {
                // Gérer tous les champs input (text, email, password, etc.) sauf le hidden parent_id
                const textInputs = formContainer.querySelectorAll('input:not([type="hidden"]), select, textarea');
                textInputs.forEach(field => {
                    if (isRequired) {
                        field.setAttribute('required', 'required');
                    } else {
                        field.removeAttribute('required');
                    }
                });

                // Gérer spécifiquement le champ caché de l'ID du parent existant
                if (parentIdInput && prefix === 'existing_parent') {
                    if (isRequired) {
                        // Le champ hidden 'parent_id' devient requis quand cet onglet est actif
                        parentIdInput.setAttribute('required', 'required');
                    } else {
                        parentIdInput.removeAttribute('required');
                        // Réinitialiser la validation personnalisée si le champ n'est plus requis
                        parentSearchInput.setCustomValidity("");
                    }
                }
            }
        }

        // Initialiser l'état des champs requis au chargement de la page
        const activeTabElement = document.querySelector('.nav-tabs .nav-link.active');
        if (activeTabElement && activeTabElement.id === 'create-new-tab') {
            toggleRequiredFields('new_parent', true);
            toggleRequiredFields('existing_parent', false);
        } else if (activeTabElement && activeTabElement.id === 'select-existing-tab') {
            toggleRequiredFields('new_parent', false);
            toggleRequiredFields('existing_parent', true);
        } else { // Par défaut si active_tab n'est pas défini (initialement 'create_new' dans la vue)
            toggleRequiredFields('new_parent', true);
            toggleRequiredFields('existing_parent', false);
        }


        // --- Logique d'Autocomplete pour les parents ---
        parentSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value;

            if (query.length < 2) { // Minimum 2 caractères pour déclencher la recherche
                parentSuggestionsDiv.innerHTML = '';
                parentSuggestionsDiv.style.display = 'none';
                parentIdInput.value = ''; // Réinitialiser l'ID si la recherche est vide
                parentSearchInput.setCustomValidity("Veuillez saisir au moins 2 caractères."); // Message d'erreur
                parentSearchInput.reportValidity();
                return;
            } else {
                parentSearchInput.setCustomValidity(""); // Effacer le message si assez de caractères
            }

            searchTimeout = setTimeout(() => {
                fetch(`${PARENT_SEARCH_URL}?term=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        // Log the error response body if available
                        return response.text().then(text => {
                            throw new Error(`HTTP error! status: ${response.status} - ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    parentSuggestionsDiv.innerHTML = ''; // Nettoyer les suggestions précédentes
                    if (data.length > 0) {
                        data.forEach(parent => {
                            const item = document.createElement('a');
                            item.href = "#";
                            item.classList.add('list-group-item', 'list-group-item-action');
                            item.textContent = parent.text;
                            item.dataset.parentId = parent.id;
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                parentSearchInput.value = parent.text; // Affiche le nom complet dans le champ
                                parentIdInput.value = parent.id; // Stocke l'ID du parent
                                parentSuggestionsDiv.innerHTML = '';
                                parentSuggestionsDiv.style.display = 'none';
                                parentSearchInput.setCustomValidity(""); // Effacer tout message d'erreur après sélection
                            });
                            parentSuggestionsDiv.appendChild(item);
                        });
                        parentSuggestionsDiv.style.display = 'block';
                    } else {
                        const noResult = document.createElement('div');
                        noResult.classList.add('list-group-item', 'text-muted');
                        noResult.textContent = "Aucun parent trouvé.";
                        parentSuggestionsDiv.appendChild(noResult);
                        parentSuggestionsDiv.style.display = 'block';
                        parentIdInput.value = ''; // S'assurer que l'ID est vide si aucun résultat
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la recherche de parents:', error);
                    parentSuggestionsDiv.innerHTML = '<div class="list-group-item text-danger">Erreur de chargement des suggestions.</div>';
                    parentSuggestionsDiv.style.display = 'block';
                    parentIdInput.value = ''; // S'assurer que l'ID est vide en cas d'erreur
                });
            }, 300); // Délai de 300ms après la dernière frappe
        });

        // Cacher les suggestions quand l'utilisateur clique en dehors
        document.addEventListener('click', function(e) {
            if (!parentSuggestionsDiv.contains(e.target) && e.target !== parentSearchInput) {
                parentSuggestionsDiv.innerHTML = '';
                parentSuggestionsDiv.style.display = 'none';
            }
        });

        // --- Gestion de la validation Bootstrap (et rechargement) ---
        const form = document.querySelector('.needs-validation');
        form.addEventListener('submit', event => {
            form.classList.remove('was-validated'); // Toujours enlever avant de re-valider
            let formIsValid = true;

            // Vérifier que action_type a une valeur (devrait toujours être le cas avec la logique des onglets)
            if (!actionTypeInput.value) {
                messages.error(request, "Erreur interne: Le type d'action du formulaire est manquant.");
                formIsValid = false;
            }

            // Validation des formulaires côté client avec HTML5 (checkValidity)
            // Valide les champs visibles et requis de l'élève
            const studentInputs = form.querySelectorAll('[name^="student-"]:not([type="hidden"])');
            studentInputs.forEach(input => {
                if (!input.checkValidity()) {
                    formIsValid = false;
                    // input.reportValidity(); // Permet d'afficher l'erreur individuellement
                }
            });


            const activeTabPane = document.querySelector('.tab-pane.show.active');
            if (activeTabPane) {
                // Validation des champs requis de l'onglet actif
                // On inclut les selects et textareas, pas seulement les inputs
                const activeTabInputs = activeTabPane.querySelectorAll('[required]:not([type="hidden"])');
                activeTabInputs.forEach(input => {
                    if (!input.checkValidity()) {
                        formIsValid = false;
                    }
                });

                // Validation spécifique pour l'onglet "Sélectionner Parent Existant"
                if (actionTypeInput.value === 'select_existing') {
                    if (parentIdInput.hasAttribute('required') && !parentIdInput.value) {
                        formIsValid = false;
                        // Afficher une erreur visuelle ou un message sur le champ de recherche
                        parentSearchInput.setCustomValidity("Veuillez sélectionner un parent dans la liste suggérée.");
                        parentSearchInput.reportValidity();
                    } else if (parentIdInput.hasAttribute('required') && parentIdInput.value) {
                        // S'il y a un ID et qu'il est requis, effacer toute validation personnalisée
                        parentSearchInput.setCustomValidity("");
                    }
                }
            } else {
                formIsValid = false; // Un onglet devrait toujours être actif
                console.error("Aucun onglet actif trouvé lors de la soumission.");
            }

            if (!formIsValid) {
                event.preventDefault(); // Empêche la soumission du formulaire
                event.stopPropagation(); // Arrête la propagation de l'événement
                form.classList.add('was-validated'); // Ajoute la classe pour afficher les messages de validation Bootstrap
            } else {
                // Si tout est valide, permet la soumission par défaut du formulaire
                // Désactiver le bouton pour éviter les doubles soumissions
                const submitButton = event.target.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';
                }
            }
        }, false);
    });
</script>
{% endblock %}