{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg p-4 mb-5 bg-white rounded">
        <h1 class="card-title text-center mb-4 text-primary">{{ title }}</h1>

        {% if messages %}
            <div class="mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
            </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100 border-primary">
                        <div class="card-header bg-primary text-white py-3">
                            <h5 class="mb-0"><i class="bi bi-person-fill"></i> Informations de l'Élève</h5>
                        </div>
                        <div class="card-body">
                            {% for field in student_form %}
                                <div class="mb-3">
                                    {{ field.label_tag }}
                                    {{ field|add_class:"form-control" }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                            {% if student_form.non_field_errors %}
                                {% for error in student_form.non_field_errors %}
                                    <div class="alert alert-danger mt-3">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 border-info">
                        <div class="card-header bg-info text-white py-3">
                            <h5 class="mb-0"><i class="bi bi-people-fill"></i> Gestion du Parent</h5>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs mb-3" id="parentTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link {% if active_tab == 'create_new' or not active_tab %}active{% endif %}" id="create-new-tab" data-bs-toggle="tab" data-bs-target="#create-new" type="button" role="tab" aria-controls="create-new" aria-selected="{% if active_tab == 'create_new' or not active_tab %}true{% else %}false{% endif %}">Créer un Nouveau Parent</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link {% if active_tab == 'select_existing' %}active{% endif %}" id="select-existing-tab" data-bs-toggle="tab" data-bs-target="#select-existing" type="button" role="tab" aria-controls="select-existing" aria-selected="{% if active_tab == 'select_existing' %}true{% else %}false{% endif %}">Sélectionner Parent Existant</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="parentTabContent">
                                {# Contenu pour Créer un Nouveau Parent #}
                                <div class="tab-pane fade {% if active_tab == 'create_new' or not active_tab %}show active{% endif %}" id="create-new" role="tabpanel" aria-labelledby="create-new-tab">
                                    <p class="text-muted">Remplissez les informations pour créer un nouveau compte parent.</p>
                                    {% for field in parent_creation_form %}
                                        <div class="mb-3">
                                            {{ field.label_tag }}
                                            {{ field|add_class:"form-control" }}
                                            {% if field.help_text %}
                                                <small class="form-text text-muted">{{ field.help_text }}</small>
                                            {% endif %}
                                            {% for error in field.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endfor %}
                                    {% if parent_creation_form.non_field_errors %}
                                        {% for error in parent_creation_form.non_field_errors %}
                                            <div class="alert alert-danger mt-3">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                {# Contenu pour Sélectionner un Parent Existant avec Autocomplete #}
                                <div class="tab-pane fade {% if active_tab == 'select_existing' %}show active{% endif %}" id="select-existing" role="tabpanel" aria-labelledby="select-existing-tab">
                                    <p class="text-muted">Recherchez et choisissez un parent déjà enregistré.</p>
                                    <div class="mb-3">
                                        <label for="id_existing_parent-parent_search_term" class="form-label">Rechercher un Parent</label>
                                        <input type="text" id="id_existing_parent-parent_search_term" name="existing_parent-parent_search_term" class="form-control" placeholder="Nom, Prénom ou Email du parent">
                                        <div id="parent-suggestions" class="list-group position-absolute w-100 z-index-1000" style="max-height: 200px; overflow-y: auto;">
                                            {# Suggestions seront injectées ici par JavaScript #}
                                        </div>
                                        {# Champ caché pour stocker l'ID du parent sélectionné #}
                                        <input type="hidden" id="id_existing_parent-parent_id" name="existing_parent-parent_id">
                                        {% if existing_parent_form.parent_id.errors %}
                                            {% for error in existing_parent_form.parent_id.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    {% if existing_parent_form.non_field_errors %}
                                        {% for error in existing_parent_form.non_field_errors %}
                                            <div class="alert alert-danger mt-3">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            <input type="hidden" name="action_type" id="action_type_input" value="{{ active_tab|default:'create_new' }}">
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-plus-circle-fill"></i> Ajouter Élève et Parent</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const createNewTabBtn = document.getElementById('create-new-tab');
        const selectExistingTabBtn = document.getElementById('select-existing-tab');
        const actionTypeInput = document.getElementById('action_type_input');

        // --- Éléments pour la recherche de parent AJAX ---
        const parentSearchInput = document.getElementById('id_existing_parent-parent_search_term');
        const parentSuggestionsDiv = document.getElementById('parent-suggestions');
        const parentIdInput = document.getElementById('id_existing_parent-parent_id');
        let searchTimeout = null;
        const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const PARENT_SEARCH_URL = "{% url 'profiles:search_parents_ajax' %}";

        // Mettre à jour le champ caché 'action_type' en fonction de l'onglet actif
        createNewTabBtn.addEventListener('shown.bs.tab', function (event) {
            actionTypeInput.value = 'create_new';
            toggleRequiredFields('new_parent', true);
            toggleRequiredFields('existing_parent', false);
        });

        selectExistingTabBtn.addEventListener('shown.bs.tab', function (event) {
            actionTypeInput.value = 'select_existing';
            toggleRequiredFields('new_parent', false);
            toggleRequiredFields('existing_parent', true);
            // Cacher les suggestions quand l'onglet change
            parentSuggestionsDiv.innerHTML = '';
            parentSuggestionsDiv.style.display = 'none';
        });

        function toggleRequiredFields(prefix, isRequired) {
            const formContainer = document.getElementById(prefix === 'new_parent' ? 'create-new' : 'select-existing');
            if (formContainer) {
                const passwordFields = formContainer.querySelectorAll('input[type="password"]');
                passwordFields.forEach(field => {
                    if (isRequired) {
                        field.setAttribute('required', 'required');
                    } else {
                        field.removeAttribute('required');
                    }
                });

                // Pour le champ caché de l'ID du parent existant (devient requis si on sélectionne)
                if (parentIdInput) {
                    if (prefix === 'existing_parent') { // Si c'est l'onglet de sélection
                        if (isRequired) {
                            // On ne rend pas l'input text de recherche 'required', mais l'input hidden 'parent_id'
                            parentIdInput.setAttribute('required', 'required');
                        } else {
                            parentIdInput.removeAttribute('required');
                        }
                    }
                }
            }
        }

        // Initialiser l'état des champs requis au chargement de la page
        const activeTab = document.querySelector('.nav-tabs .nav-link.active');
        if (activeTab && activeTab.id === 'create-new-tab') {
            toggleRequiredFields('new_parent', true);
            toggleRequiredFields('existing_parent', false);
        } else if (activeTab && activeTab.id === 'select-existing-tab') {
            toggleRequiredFields('new_parent', false);
            toggleRequiredFields('existing_parent', true);
        } else { // Par défaut si active_tab n'est pas défini (initialement 'create_new')
            toggleRequiredFields('new_parent', true);
            toggleRequiredFields('existing_parent', false);
        }

        // --- Logique d'Autocomplete pour les parents ---
        parentSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value;

            if (query.length < 2) { // Minimum 2 caractères pour déclencher la recherche
                parentSuggestionsDiv.innerHTML = '';
                parentSuggestionsDiv.style.display = 'none';
                parentIdInput.value = ''; // Réinitialiser l'ID si la recherche est vide
                return;
            }

            searchTimeout = setTimeout(() => {
                // CORRECTION ICI : Utilisation correcte du template literal avec fetch
                fetch(${PARENT_SEARCH_URL}?term=${encodeURIComponent(query)}, {
                    method: 'GET', // Spécifier explicitement GET, bien que ce soit la valeur par défaut pour fetch sans corps
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest', // Important pour Django is_ajax() (bien que déprécié, encore utile)
                        // 'X-CSRFToken': CSRF_TOKEN // Pas nécessaire pour les requêtes GET sans données sensibles dans le corps
                    }
                })
                .then(response => {
                    if (!response.ok) { // Gérer les erreurs HTTP
                        throw new Error(HTTP error! status: ${response.status});
                    }
                    return response.json();
                })
                .then(data => {
                    parentSuggestionsDiv.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(parent => {
                            const item = document.createElement('a');
                            item.href = "#";
                            item.classList.add('list-group-item', 'list-group-item-action');
                            item.textContent = parent.text;
                            item.dataset.parentId = parent.id;
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                parentSearchInput.value = parent.text; // Affiche le nom complet dans le champ
                                parentIdInput.value = parent.id; // Stocke l'ID du parent
                                parentSuggestionsDiv.innerHTML = '';
                                parentSuggestionsDiv.style.display = 'none';
                            });
                            parentSuggestionsDiv.appendChild(item);
                        });
                        parentSuggestionsDiv.style.display = 'block';
                    } else {
                        const noResult = document.createElement('div');
                        noResult.classList.add('list-group-item', 'text-muted');
                        noResult.textContent = "Aucun parent trouvé.";
                        parentSuggestionsDiv.appendChild(noResult);
                        parentSuggestionsDiv.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la recherche de parents:', error);
                    parentSuggestionsDiv.innerHTML = '<div class="list-group-item text-danger">Erreur de chargement des suggestions.</div>';
                    parentSuggestionsDiv.style.display = 'block';
                });
            }, 300); // Délai de 300ms après la dernière frappe
        });

        // Cacher les suggestions quand l'utilisateur clique en dehors
        document.addEventListener('click', function(e) {
            if (!parentSuggestionsDiv.contains(e.target) && e.target !== parentSearchInput) {
                parentSuggestionsDiv.innerHTML = '';
                parentSuggestionsDiv.style.display = 'none';
            }
        });

        // --- Gestion de la validation Bootstrap (et rechargement) ---
        const form = document.querySelector('.needs-validation');
        form.addEventListener('submit', event => {
            form.classList.remove('was-validated');
            let formIsValid = true;

            // Validation du formulaire élève
            if (form.querySelector('[name^="student-"]:invalid')) {
                formIsValid = false;
            }

            // Validation des champs de l'onglet actif
            const activeTabPane = document.querySelector('.tab-pane.show.active');
            if (activeTabPane) {
                const inputs = activeTabPane.querySelectorAll('[required]');
                let allTabInputsValid = true;
                inputs.forEach(input => {
                    if (!input.checkValidity()) {
                        allTabInputsValid = false;
                    }
                });

                if (!allTabInputsValid) {
                    formIsValid = false;
                }

                // Spécifique pour l'onglet de sélection de parent :
                // Assurez-vous qu'un parent a été sélectionné si cet onglet est actif et requis
                if (actionTypeInput.value === 'select_existing' && parentIdInput.hasAttribute('required')) {
                    if (!parentIdInput.value) { // Si l'ID du parent est vide
                        formIsValid = false;
                        // Afficher une erreur visuelle ou un message
                        parentSearchInput.setCustomValidity("Veuillez sélectionner un parent dans la liste.");
                        parentSearchInput.reportValidity(); // Afficher le message d'erreur
                    } else {
                        parentSearchInput.setCustomValidity(""); // Réinitialiser si valide
                    }
                }
            } else {
                formIsValid = false; // Ne devrait pas arriver
            }

            if (!formIsValid) {
                event.preventDefault();
                event.stopPropagation();
                form.classList.add('was-validated');
            } else {
                // Si tout est valide, permet la soumission par défaut du formulaire
                // Désactiver le bouton pour éviter les doubles soumissions
                event.target.querySelector('button[type="submit"]').disabled = true;
                event.target.querySelector('button[type="submit"]').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';
                // Le formulaire se soumettra maintenant normalement au serveur
            }
        }, false);
    });
</script>
{% endblock %} 