{% extends 'base.html' %} {# Assurez-vous que le chemin vers votre base.html est correct #}

{% load static %} {# Pour charger des fichiers statiques comme le CSS ou JS si vous en avez #}

{% load profiles_extras %}

{% block title %}Tableau de Bord Comptable{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="text-center mb-4">Tableau de Bord Comptable</h1>

    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}

    {% if request.user.is_authenticated and request.user.user_type in 'ADMIN,ACCOUNTANT,DIRECTION' %} {# IF PRINCIPAL #}
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Vue d'ensemble Financière de l'École</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Bienvenue, {{ request.user.full_name }}. Vous êtes connecté en tant que {{ request.user.get_user_type_display }}.
                    </p>
                    <p class="card-text">
                        Goma, North-Kivu, Democratic Republic of the Congo.
                        Date et heure actuelles : {{ "now"|date:"l j F Y H:i" }}
                    </p>
                    {% if current_school %} {# IF current_school (ligne 61) #}
                        <p class="card-text">
                            Informations financières pour l'école : <strong>{{ current_school.name }}</strong>
                            {% if active_period %}
                                (Période Académique : <strong>{{ active_period.name }}</strong>)
                            {% endif %}
                        </p>
                    {% else %} {# ELSE de IF current_school #}
                        <p class="card-text">
                            Aucune école affiliée pour le moment. Veuillez contacter l'administrateur.
                        </p>
                    {% endif %} {# ENDIF de IF current_school #}
                </div>
            </div>
        </div>
    </div>

    {% if current_school %} {# N'afficher les cards que si une école est associée - CE BLOC EST CORRECT MAINTENANT #}
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-success mb-3">
                    <div class="card-header">Montant Total Payé</div>
                    <div class="card-body">
                        <h3 class="card-title">{{ total_paid_for_school|floatformat:2 }} $</h3>
                        <p class="card-text">Total des paiements enregistrés pour cette période/école.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-info mb-3">
                    <div class="card-header">Montant Total des Frais Attendus</div>
                    <div class="card-body">
                        <h3 class="card-title">{{ total_expected_for_school|floatformat:2 }} $</h3>
                        <p class="card-text">Total des frais de scolarité attendus pour cette période/école.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-warning mb-3">
                    <div class="card-header">Solde Restant / Montant Dû (Global)</div>
                    <div class="card-body">
                        <h3 class="card-title">{{ remaining_balance_for_school|floatformat:2 }} $</h3>
                        <p class="card-text">
                            Montant restant à percevoir pour la période actuelle.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <hr> {# Séparateur #}

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Enregistrer un Nouveau Paiement</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'profiles:accounting_dashboard' %}">
                            {% csrf_token %}
                            <input type="hidden" name="add_payment" value="true"> {# Champ caché pour identifier l'action #}
                            {{ payment_form.as_p }}
                            <button type="submit" class="btn btn-success mt-3">Enregistrer Paiement</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Définir/Modifier les Frais de Scolarité</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'profiles:accounting_dashboard' %}">
                            {% csrf_token %}
                            <input type="hidden" name="set_tuition_fee" value="true"> {# Champ caché pour identifier l'action #}
                            {{ tuition_fee_form.as_p }}
                            <button type="submit" class="btn btn-info mt-3">Définir Frais</button>
                        </form>
                        <h6 class="mt-4">Frais de Scolarité Définis pour la période actuelle :</h6>
                        {% if tuition_fees_set %} {# Vous devrez passer 'tuition_fees_set' depuis la vue #}
                        <ul class="list-group">
                            {% for fee in tuition_fees_set %}
                            <li class="list-group-item">
                                <strong>{{ fee.classe.name }}</strong> ({{ fee.fee_type.name }}): <strong>{{ fee.amount|floatformat:2 }} $</strong>
                                <small class="text-muted"> (Défini par: {{ fee.set_by.full_name|default:'N/A' }} le {{ fee.date_set|date:"d M Y" }})</small>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted">Aucun frais de scolarité défini pour cette période.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Ajouter un Intitulé de Frais</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'profiles:accounting_dashboard' %}">
                            {% csrf_token %}
                            <input type="hidden" name="add_fee_type" value="true"> {# Champ caché pour identifier l'action #}
                            {{ fee_type_form.as_p }}
                            <button type="submit" class="btn btn-primary mt-3">Ajouter Intitulé</button>
                        </form>
                        <h6 class="mt-4">Types de Frais Existants :</h6>
                        {% if fee_types %} {# Vous devrez passer 'fee_types' depuis la vue #}
                        <ul class="list-group">
                            {% for ft in fee_types %}
                            <li class="list-group-item">{{ ft.name }} {% if not ft.is_active %}(Inactif){% endif %}</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted">Aucun type de frais défini.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <hr> {# Séparateur #}

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Statut des Paiements par Élève (Période Actuelle)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th>Élève</th>
                                        <th>Classe</th>
                                        <th>Frais Dûs</th>
                                        <th>Montant Payé</th>
                                        <th>Solde Restant</th>
                                        <th>Statut</th>
                                        <th>Actions (Parents)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for status in student_payment_status %}
                                    {% with student_status_data=student_payment_status|get_student_status:status.student.id %}
                                    <tr>
                                        <td>{{ status.student.full_name }}</td>
                                        <td>{{ status.student.current_classe.name|default:"N/A" }}</td>
                                        <td>{{ status.fees_due|floatformat:2 }} $</td>
                                        <td>{{ status.amount_paid|floatformat:2 }} $</td>
                                        <td>{{ status.remaining_balance|floatformat:2 }} $</td>
                                        <td class="{{ status.status_class }}">
                                            {{ status.status_text }}
                                        </td>
                                        <td>
                                            {% if status.parents %}
                                                {% for parent in status.parents %}
                                                    <span class="badge bg-secondary">{{ parent.full_name }}</span>
                                                    <form method="post" action="{% url 'school:send_notification' %}" style="display:inline-block; margin-left: 5px;">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="recipient_user_id" value="{{ parent.id }}"> {# Utiliser parent.id qui est le CustomUser ID #}
                                                        <input type="hidden" name="subject" value="Rappel de frais pour {{ status.student.full_name }}">
                                                        <input type="hidden" name="message" value="Bonjour {{ parent.full_name }},\n\nUn rappel amical concernant le solde de {{ status.remaining_balance|floatformat:2 }}$ pour les frais de scolarité de {{ status.student.full_name }}. Veuillez consulter le tableau de bord pour plus de détails.\n\nCordialement,\nL'Administration de {{ current_school.name }}">
                                                        <button type="submit" class="btn btn-sm btn-outline-primary" title="Notifier {{ parent.full_name }}">
                                                            Notifier
                                                        </button>
                                                    </form>
                                                    {% if not forloop.last %}<br>{% endif %}
                                                {% endfor %}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endwith %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr> {# Séparateur #}

        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Détail des Derniers Paiements</h5>
                    </div>
                    <div class="card-body">
                        {% if payments_list %}
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th>Élève</th>
                                        <th>Type de Frais</th>
                                        <th>Montant Payé</th>
                                        <th>Date de Paiement</th>
                                        <th>Statut</th>
                                        <th>ID Transaction</th>
                                        <th>Période Académique</th>
                                        <th>Enregistré par</th>
                                        <th>Reçu PDF</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in payments_list %}
                                    <tr>
                                        <td>{{ payment.student.full_name }}</td>
                                        <td>{{ payment.fee_type.name|default:"N/A" }}</td>
                                        <td>{{ payment.amount_paid|floatformat:2 }} $</td>
                                        <td>{{ payment.payment_date|date:"d M Y" }}</td>
                                        <td>{{ payment.get_payment_status_display }}</td>
                                        <td>{{ payment.transaction_id|default:"N/A" }}</td>
                                        <td>{{ payment.academic_period.name }}</td>
                                        <td>{{ payment.recorded_by.full_name|default:"N/A" }}</td>
                                        <td>
                                            {% if payment.receipt_file %}
                                                <a href="{{ payment.receipt_file.url }}" target="_blank" class="btn btn-sm btn-outline-secondary">Voir Reçu</a>
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">Aucun paiement enregistré pour le moment.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %} {# NOUVEAU : C'EST ICI QUE LE {% if current_school %} de la ligne 61 DOIT ÊTRE FERMÉ. #}

    {% else %} {# ELSE du IF PRINCIPAL (ligne 25) #}
    <div class="alert alert-danger text-center" role="alert">
        Accès refusé. Vous n'avez pas les autorisations nécessaires pour accéder à ce tableau de bord, ou vous n'êtes pas associé à une école.
    </div>
    {% endif %} {# ENDIF du IF PRINCIPAL (ligne 25) #}

</div> {# FERMETURE de <div class="container-fluid mt-4"> #}

{% endblock %}

{% block extra_js %}
    {# Script pour la suppression automatique de l'alerte après quelques secondes #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    // Utilise la fonction de Bootstrap pour fermer l'alerte
                    var bootstrapAlert = new bootstrap.Alert(alert);
                    bootstrapAlert.close();
                }, 5000); // 5000 millisecondes = 5 secondes
            });
        });
    </script>
{% endblock %}