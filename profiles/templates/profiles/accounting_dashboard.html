{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg p-4 mb-5 bg-white rounded">
        <h1 class="card-title text-center mb-4 text-primary"><i class="bi bi-cash-stack"></i> Tableau de Bord Comptable</h1>

        {% if messages %}
            <div class="mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
            </div>
        {% endif %}

        {# Message si aucune période académique active #}
        {% if not active_academic_period %}
        <div class="alert alert-warning mb-4" role="alert">
            <i class="bi bi-info-circle-fill"></i> Aucune période académique active n'a été trouvée pour votre école. Les données financières affichées pourraient être incomplètes ou incorrectes. Veuillez définir ou activer une période académique dans les paramètres de l'école.
        </div>
        {% endif %}

        {# NOUVEAU BOUTON : Enregistrer un Paiement #}
        <div class="d-flex justify-content-end mb-4">
            <a href="{% url 'profiles:payment_create' %}" class="btn btn-success btn-lg me-2">
                <i class="bi bi-plus-circle-fill"></i> Enregistrer un Nouveau Paiement
            </a>
            <a href="#manage-fees-section" class="btn btn-info btn-lg">
                <i class="bi bi-pencil-square"></i> Gérer les Frais
            </a>
        </div>

        <div class="row g-4 mt-4">
            {# Section Résumé Global (Mise à jour pour correspondre au design de l'image) #}
            <div class="col-md-12">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="card border-primary text-center h-100">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Solde global actuel</h6>
                                <h2 class="card-title {% if remaining_balance_for_school > 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ remaining_balance_for_school|floatformat:2 }} $
                                </h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success text-center h-100">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Paiements encaissés (Jour)</h6>
                                <h2 class="card-title text-success">{{ total_paid_today|floatformat:2 }} $</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success text-center h-100">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Total des paiements (Période)</h6>
                                <h2 class="card-title text-success">{{ total_paid_for_school|floatformat:2 }} $</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning text-center h-100">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Élèves en retard</h6>
                                <h2 class="card-title text-warning">{{ num_students_in_arrears }}</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Section Alertes (simple pour l'instant) #}
            {% if num_students_overpaid > 0 %}
            <div class="col-md-12 mt-3">
                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" role="img" aria-label="Warning:"></i>
                    <div>
                        <strong>Alertes :</strong> {{ num_students_overpaid }} élève(s) a/ont un solde excédentaire (trop payé).
                    </div>
                </div>
            </div>
            {% endif %}

            {# Graphiques #}
            <div class="col-md-6">
                <div class="card border-primary mb-3">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Évolution des Paiements (7 derniers jours)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="paymentEvolutionChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-info mb-3">
                    <div class="card-header bg-info text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-pie-chart-fill"></i> Répartition des Sources de Revenu</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="revenueSourceChart"></canvas>
                    </div>
                </div>
            </div>

            {# Section Statut des Paiements par Élève #}
            <div class="col-md-12">
                <div class="card border-info mb-3">
                    <div class="card-header bg-info text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-person-lines-fill"></i> Statut des Paiements par Élève</h5>
                    </div>
                    <div class="card-body">
                        {# Formulaire de filtre amélioré #}
                        <form method="GET" class="row g-3 align-items-end mb-4">
                            <div class="col-md-4">
                                <label for="class_filter" class="form-label">Filtrer par Classe</label>
                                <select name="class_id" id="class_filter" class="form-select">
                                    <option value="">Toutes les classes</option>
                                    {% for class_obj in classes %}
                                        <option value="{{ class_obj.id }}" {% if selected_class_id == class_obj.id %}selected{% endif %}>{{ class_obj.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="payment_date_filter" class="form-label">Filtrer par Date de Paiement</label>
                                <input type="date" name="payment_date" id="payment_date_filter" class="form-control" value="{{ selected_payment_date|default_if_none:'' }}">
                            </div>
                             <div class="col-md-4">
                                <label for="fee_type_filter" class="form-label">Filtrer par Type de Frais</label>
                                <select name="fee_type_id" id="fee_type_filter" class="form-select">
                                    <option value="">Tous les types de frais</option>
                                    {% for fee_type_obj in fee_types %}
                                        <option value="{{ fee_type_obj.id }}" {% if selected_fee_type_id == fee_type_obj.id %}selected{% endif %}>{{ fee_type_obj.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary"><i class="bi bi-funnel-fill"></i> Appliquer les filtres</button>
                                <a href="{% url 'profiles:accounting_dashboard' %}" class="btn btn-outline-secondary ms-2"><i class="bi bi-x-circle"></i> Réinitialiser</a>
                            </div>
                        </form>

                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>Élève</th>
                                        <th>Classe</th>
                                        <th>Parents</th>
                                        <th>Frais Dûs</th>
                                        <th>Montant Payé</th>
                                        <th>Solde Restant</th>
                                        <th>Statut</th>
                                        <th>Actions</th> {# Nouvelle colonne pour les actions #}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for status in student_payment_status %}
                                    <tr>
                                        <td>{{ status.student.full_name }}</td>
                                        <td>{{ status.student.current_classe.name }}</td>
                                        <td>
                                            {% for parent in status.parents %}
                                                {{ parent.full_name }}{% if not forloop.last %}, {% endif %}
                                            {% empty %}
                                                N/A
                                            {% endfor %}
                                        </td>
                                        <td>{{ status.fees_due|floatformat:2 }} $</td>
                                        <td>{{ status.amount_paid|floatformat:2 }} $</td>
                                        <td class="{% if status.remaining_balance > 0 %}text-danger{% elif status.remaining_balance < 0 %}text-success{% endif %}">
                                            {{ status.remaining_balance|floatformat:2 }} $
                                        </td>
                                        <td><span class="badge {{ status.status_class }}">{{ status.status_text }}</span></td>
                                        <td>
                                            {# Bouton pour enregistrer un paiement pour cet élève #}
                                            <a href="{% url 'profiles:payment_create' %}?student_id={{ status.student.id }}" class="btn btn-sm btn-outline-success" title="Enregistrer Paiement">
                                                <i class="bi bi-plus-circle"></i> Payer
                                            </a>
                                            {# Ajoutez d'autres actions ici, ex: voir historique, envoyer message #}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center">Aucun élève trouvé pour cette période ou classe avec les filtres appliqués.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            {# Dernière paiements #}
            <div class="col-md-6">
                <div class="card border-success mb-3">
                    <div class="card-header bg-success text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Derniers Paiements Enregistrés (Top 10)</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {% for payment in payments_list %}
                                <li class="list-group-item d-flex justify-content-between align-items-start">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-bold">{{ payment.student.full_name }}</div>
                                        <small class="text-muted">{{ payment.fee_type.name }} - {{ payment.payment_date|date:"d M Y" }}</small>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">{{ payment.amount_paid|floatformat:2 }} $</span>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-center text-muted">Aucun paiement récent.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            {# Frais de Scolarité Définis #}
            <div class="col-md-6" id="manage-fees-section">
                <div class="card border-warning mb-3">
                    <div class="card-header bg-warning text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-wallet-fill"></i> Frais de Scolarité Définis</h5>
                    </div>
                    <div class="card-body">
                        {# Formulaire pour définir les frais de scolarité #}
                        <h6 class="mb-3">Définir les Frais par Classe et Type</h6>
                        <form method="post" class="needs-validation mb-4" novalidate>
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="{{ tuition_fee_form.fee_type.id_for_label }}" class="form-label">{{ tuition_fee_form.fee_type.label }}</label>
                                {% if tuition_fee_form.fee_type.errors %}
                                    {% render_field tuition_fee_form.fee_type class="form-select is-invalid" %}
                                {% else %}
                                    {% render_field tuition_fee_form.fee_type class="form-select" %}
                                {% endif %}
                                {% for error in tuition_fee_form.fee_type.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ tuition_fee_form.classe.id_for_label }}" class="form-label">{{ tuition_fee_form.classe.label }}</label>
                                {% if tuition_fee_form.classe.errors %}
                                    {% render_field tuition_fee_form.classe class="form-select is-invalid" %}
                                {% else %}
                                    {% render_field tuition_fee_form.classe class="form-select" %}
                                {% endif %}
                                {% for error in tuition_fee_form.classe.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="mb-3 d-none"> {# Cachez le champ academic_period si vous le gérez automatiquement dans la vue #}
                                {% render_field tuition_fee_form.academic_period %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ tuition_fee_form.amount.id_for_label }}" class="form-label">{{ tuition_fee_form.amount.label }}</label>
                                {% if tuition_fee_form.amount.errors %}
                                    {% render_field tuition_fee_form.amount class="form-control is-invalid" %}
                                {% else %}
                                    {% render_field tuition_fee_form.amount class="form-control" %}
                                {% endif %}
                                {% for error in tuition_fee_form.amount.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% if tuition_fee_form.non_field_errors %}
                                <div class="alert alert-danger mt-3">{{ tuition_fee_form.non_field_errors }}</div>
                            {% endif %}
                            
    
                            <button type="submit" name="set_tuition_fee" class="btn btn-warning"><i class="bi bi-cash"></i> Définir/Mettre à jour les Frais</button>
                        </form>
                        
                        <h6 class="mb-3 mt-4">Frais Définis Actuellement</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Classe</th>
                                        <th>Type de Frais</th>
                                        <th>Montant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for fee in tuition_fees_set %}
                                    <tr>
                                        <td>{{ fee.classe.name }}</td>
                                        <td>{{ fee.fee_type.name }}</td>
                                        <td>{{ fee.amount|floatformat:2 }} $</td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="3" class="text-center text-muted">Aucun frais défini.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            {# Formulaire pour ajouter un type de frais #}
            <div class="col-md-6">
                <div class="card border-secondary mb-3">
                    <div class="card-header bg-secondary text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-tags-fill"></i> Ajouter un Type de Frais</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" class="needs-validation" novalidate>
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="{{ fee_type_form.name.id_for_label }}" class="form-label">{{ fee_type_form.name.label }}</label>
                                {% if fee_type_form.name.errors %}
                                    {% render_field fee_type_form.name class="form-control is-invalid" %}
                                {% else %}
                                    {% render_field fee_type_form.name class="form-control" %}
                                {% endif %}
                                {% for error in fee_type_form.name.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ fee_type_form.description.id_for_label }}" class="form-label">{{ fee_type_form.description.label }}</label>
                                {% if fee_type_form.description.errors %}
                                    {% render_field fee_type_form.description class="form-control is-invalid" %}
                                {% else %}
                                    {% render_field fee_type_form.description class="form-control" %}
                                {% endif %}
                                {% for error in fee_type_form.description.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="form-check mb-3">
                                {% if fee_type_form.is_active.errors %}
                                    {% render_field fee_type_form.is_active class="form-check-input is-invalid" %}
                                {% else %}
                                    {% render_field fee_type_form.is_active class="form-check-input" %}
                                {% endif %}
                                <label class="form-check-label" for="{{ fee_type_form.is_active.id_for_label }}">
                                    {{ fee_type_form.is_active.label }}
                                </label>
                                {% for error in fee_type_form.is_active.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% if fee_type_form.non_field_errors %}
                                <div class="alert alert-danger mt-3">{{ fee_type_form.non_field_errors }}</div>
                            {% endif %}
                            <button type="submit" name="add_fee_type" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Ajouter Type de Frais</button>
                        </form>
                    </div>
                </div>
            </div>

        </div> {# End row g-4 #}

    </div> {# End card #}
</div> {# End container #}
{% endblock %}

{% block extra_js %}
{# Bootstrap Icons CDN (already there, just to confirm) #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{# Chart.js CDN #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Data for Payment Evolution Chart (Bar Chart)
        const paymentEvolutionLabels = {{ payment_evolution_labels|safe }};
        const paymentEvolutionData = {{ payment_evolution_data|safe }};

        const paymentEvolutionCtx = document.getElementById('paymentEvolutionChart').getContext('2d');
        new Chart(paymentEvolutionCtx, {
            type: 'bar',
            data: {
                labels: paymentEvolutionLabels,
                datasets: [{
                    label: 'Montant Payé ($)',
                    data: paymentEvolutionData,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)', // Blue
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // Hide legend if only one dataset
                    },
                    title: {
                        display: true,
                        text: 'Paiements Quotidiens'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Montant ($)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Jour'
                        }
                    }
                }
            }
        });

        // Data for Revenue Source Chart (Doughnut Chart)
        const revenueSourceLabels = {{ fee_type_labels|safe }};
        const revenueSourceData = {{ fee_type_data|safe }};

        // Generate dynamic colors for the doughnut chart
        const generateColors = (numColors) => {
            const colors = [];
            for (let i = 0; i < numColors; i++) {
                const hue = (i * 137.508) % 360; // Use golden angle approximation for even spread
                colors.push(`hsl(${hue}, 70%, 50%)`);
            }
            return colors;
        };
        const backgroundColors = generateColors(revenueSourceLabels.length);


        const revenueSourceCtx = document.getElementById('revenueSourceChart').getContext('2d');
        new Chart(revenueSourceCtx, {
            type: 'doughnut',
            data: {
                labels: revenueSourceLabels,
                datasets: [{
                    label: 'Montant ($)',
                    data: revenueSourceData,
                    backgroundColor: backgroundColors,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right', // Position legend to the right
                        align: 'center',
                        labels: {
                            boxWidth: 20,
                            padding: 15
                        }
                    },
                    title: {
                        display: true,
                        text: 'Répartition par Type de Frais'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed) {
                                    label += new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'USD' }).format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}