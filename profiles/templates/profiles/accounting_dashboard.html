{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg p-4 mb-5 bg-white rounded">
        <h1 class="card-title text-center mb-4 text-primary"><i class="bi bi-cash-stack"></i> Tableau de Bord Comptable</h1>

        {% if messages %}
            <div class="mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
            </div>
        {% endif %}

        {# NOUVEAU BOUTON : Enregistrer un Paiement #}
        <div class="d-flex justify-content-end mb-4">
            <a href="{% url 'profiles:payment_create' %}" class="btn btn-success btn-lg me-2">
                <i class="bi bi-plus-circle-fill"></i> Enregistrer un Nouveau Paiement
            </a>
            {# Ajoutez ici d'autres boutons pour les prochaines sections #}
            <button class="btn btn-info btn-lg">
                <i class="bi bi-pencil-square"></i> Gérer les Frais
            </button>
        </div>

        {# ... Le reste du contenu de votre tableau de bord ... #}
        {# Supprimez la section du formulaire de paiement de cet endroit #}
        {# Si vous avez des sections pour les formulaires de paiement et de définition de frais, supprimez-les ici #}

        <div class="row g-4 mt-4">
            {# Section Résumé Global (peut rester) #}
            <div class="col-md-12">
                <div class="card border-primary mb-3">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-bar-chart-fill"></i> Résumé Financier Global {% if active_period %}(Période: {{ active_period.name }}){% endif %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <h3>{{ total_expected_for_school|floatformat:2 }} $</h3>
                                <p class="text-muted">Frais Attendus</p>
                            </div>
                            <div class="col-md-4">
                                <h3>{{ total_paid_for_school|floatformat:2 }} $</h3>
                                <p class="text-muted">Montant Payé</p>
                            </div>
                            <div class="col-md-4">
                                <h3 class="{% if remaining_balance_for_school > 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ remaining_balance_for_school|floatformat:2 }} $
                                </h3>
                                <p class="text-muted">Solde Restant</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Section Statut des Paiements par Élève #}
            <div class="col-md-12">
                <div class="card border-info mb-3">
                    <div class="card-header bg-info text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-person-lines-fill"></i> Statut des Paiements par Élève</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <form method="GET" class="d-flex">
                                <select name="class_id" id="class_filter" class="form-select me-2" onchange="this.form.submit()">
                                    <option value="">Toutes les classes</option>
                                    {% for class_obj in classes %}
                                        <option value="{{ class_obj.id }}" {% if selected_class_id == class_obj.id %}selected{% endif %}>{{ class_obj.name }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>Élève</th>
                                        <th>Classe</th>
                                        <th>Parents</th>
                                        <th>Frais Dûs</th>
                                        <th>Montant Payé</th>
                                        <th>Solde Restant</th>
                                        <th>Statut</th>
                                        <th>Actions</th> {# Nouvelle colonne pour les actions #}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for status in student_payment_status %}
                                    <tr>
                                        <td>{{ status.student.full_name }}</td>
                                        <td>{{ status.student.current_classe.name }}</td>
                                        <td>
                                            {% for parent in status.parents %}
                                                {{ parent.full_name }}{% if not forloop.last %}, {% endif %}
                                            {% empty %}
                                                N/A
                                            {% endfor %}
                                        </td>
                                        <td>{{ status.fees_due|floatformat:2 }} $</td>
                                        <td>{{ status.amount_paid|floatformat:2 }} $</td>
                                        <td class="{% if status.remaining_balance > 0 %}text-danger{% elif status.remaining_balance < 0 %}text-success{% endif %}">
                                            {{ status.remaining_balance|floatformat:2 }} $
                                        </td>
                                        <td><span class="badge {{ status.status_class }}">{{ status.status_text }}</span></td>
                                        <td>
                                            {# Bouton pour enregistrer un paiement pour cet élève #}
                                            <a href="{% url 'profiles:payment_create' %}?student_id={{ status.student.id }}" class="btn btn-sm btn-outline-success" title="Enregistrer Paiement">
                                                <i class="bi bi-plus-circle"></i> Payer
                                            </a>
                                            {# Ajoutez d'autres actions ici, ex: voir historique, envoyer message #}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center">Aucun élève trouvé pour cette période ou classe.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            {# Autres sections comme paiements récents, frais définis, etc. #}
            {# S'assurer que les formulaires de POST pour l'ajout de paiement et la définition de frais sont supprimés #}

            {# Exemple: Dernière paiements (peut rester) #}
            <div class="col-md-6">
                <div class="card border-success mb-3">
                    <div class="card-header bg-success text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Derniers Paiements Enregistrés</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {% for payment in payments_list %}
                                <li class="list-group-item d-flex justify-content-between align-items-start">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-bold">{{ payment.student.full_name }}</div>
                                        <small class="text-muted">{{ payment.fee_type.name }} - {{ payment.payment_date|date:"d M Y" }}</small>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">{{ payment.amount_paid|floatformat:2 }} $</span>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-center text-muted">Aucun paiement récent.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            {# Exemple: Frais de Scolarité Définis (peut rester) #}
            <div class="col-md-6">
                <div class="card border-warning mb-3">
                    <div class="card-header bg-warning text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-wallet-fill"></i> Frais de Scolarité Définis</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Classe</th>
                                        <th>Type de Frais</th>
                                        <th>Montant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for fee in tuition_fees_set %}
                                    <tr>
                                        <td>{{ fee.classe.name }}</td>
                                        <td>{{ fee.fee_type.name }}</td>
                                        <td>{{ fee.amount|floatformat:2 }} $</td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="3" class="text-center text-muted">Aucun frais défini.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            {# Formulaire pour ajouter un type de frais (peut rester ici ou être déplacé) #}
            <div class="col-md-6">
                <div class="card border-secondary mb-3">
                    <div class="card-header bg-secondary text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-tags-fill"></i> Ajouter un Type de Frais</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" class="needs-validation" novalidate>
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="{{ fee_type_form.name.id_for_label }}" class="form-label">{{ fee_type_form.name.label }}</label>
                                {% render_field fee_type_form.name class="form-control" %}
                                {% for error in fee_type_form.name.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% if fee_type_form.non_field_errors %}
                                <div class="alert alert-danger mt-3">{{ fee_type_form.non_field_errors }}</div>
                            {% endif %}
                            <button type="submit" name="add_fee_type" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Ajouter Type de Frais</button>
                        </form>
                    </div>
                </div>
            </div>

        </div> {# End row g-4 #}

    </div> {# End card #}
</div> {# End container #}
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{# Ajoutez ici tout JS spécifique à ce tableau de bord, comme la validation #}
{% endblock %}