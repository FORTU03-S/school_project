{# profiles/templates/profiles/student_profile.html #}

{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">{{ title }}</h2>
    <p><a href="{% url 'profiles:list_students' %}" class="btn btn-sm btn-outline-secondary mb-3">Retour à la liste des élèves</a></p>

    {# Section Informations Générales #}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Informations Générales</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Code ID Élève :</strong> {{ student.student_id_code }}</p>
                    <p><strong>Prénom :</strong> {{ student.first_name }}</p>
                    <p><strong>Nom :</strong> {{ student.last_name }}</p>
                    <p><strong>Date de Naissance :</strong> {{ student.date_of_birth|date:"d/m/Y" }}</p>
                    <p><strong>Sexe :</strong> {{ student.get_gender_display }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Classe Actuelle :</strong> {{ student.current_class.name|default:"Non attribuée" }}</p>
                    <p><strong>Actif :</strong> 
                        {% if student.is_active %}<span class="badge bg-success">Oui</span>{% else %}<span class="badge bg-danger">Non</span>{% endif %}
                    </p>
                    <p><strong>Email :</strong> {{ student.email }}</p>
                    <p><strong>Téléphone :</strong> {{ student.phone_number|default:"N/A" }}</p>
                </div>
            </div>
        </div>
    </div>

    {# Section Informations sur les Parents #}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0">Informations sur les Parents</h4>
        </div>
        <div class="card-body">
            {% if student.parents.all %}
                <ul class="list-group list-group-flush">
                {% for parent in student.parents.all %}
                    <li class="list-group-item">
                        <strong>Nom :</strong> {{ parent.get_full_name|default:parent.email }}<br>
                        <strong>Email :</strong> {{ parent.email }}<br>
                        <strong>Téléphone :</strong> {{ parent.phone_number|default:"N/A" }}
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>Aucun parent lié à cet élève.</p>
            {% endif %}
        </div>
    </div>

    {# Section Notes (Grades) #}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0">Notes des Évaluations</h4>
        </div>
        <div class="card-body">
            {% if grades %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Évaluation</th>
                                <th>Cours</th>
                                <th>Note</th>
                                <th>Date</th>
                                <th>Commentaire</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for grade in grades %}
                            <tr>
                                <td>{{ grade.evaluation.name }}</td>
                                <td>{{ grade.evaluation.course.name }}</td>
                                <td><span class="badge bg-primary">{{ grade.score }}</span></td>
                                <td>{{ grade.date_given|date:"d/m/Y H:i" }}</td>
                                <td>{{ grade.comment|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Aucune note enregistrée pour cet élève.</p>
            {% endif %}
        </div>
    </div>

    {# Section Rapports Disciplinaires #}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-danger text-white">
            <h4 class="mb-0">Rapports Disciplinaires</h4>
        </div>
        <div class="card-body">
            {% if disciplinary_records %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type d'Incident</th>
                                <th>Description</th>
                                <th>Conséquence</th>
                                <th>Résolu</th>
                                <th>Rapporté par</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in disciplinary_records %}
                            <tr>
                                <td>{{ record.date_recorded|date:"d/m/Y H:i" }}</td>
                                <td>{{ record.incident_type }}</td>
                                <td>{{ record.description }}</td>
                                <td>{{ record.consequence|default:"-" }}</td>
                                <td>
                                    {% if record.is_resolved %}
                                        <span class="badge bg-success">Oui</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Non</span>
                                    {% endif %}
                                </td>
                                <td>{{ record.reported_by.get_full_name|default:record.reported_by.email }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Aucun rapport disciplinaire enregistré pour cet élève.</p>
            {% endif %}
        </div>
    </div>

    {# Section Historique des Présences #}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">Historique des Présences</h4>
        </div>
        <div class="card-body">
            {% if attendances %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Statut</th>
                                <th>Raison</th>
                                <th>Enregistré par</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attendance in attendances %}
                            <tr>
                                <td>{{ attendance.date|date:"d/m/Y" }}</td>
                                <td>
                                    {% if attendance.status == 'PRESENT' %}
                                        <span class="badge bg-success">{{ attendance.get_status_display }}</span>
                                    {% elif attendance.status == 'ABSENT' %}
                                        <span class="badge bg-danger">{{ attendance.get_status_display }}</span>
                                    {% elif attendance.status == 'LATE' %}
                                        <span class="badge bg-warning text-dark">{{ attendance.get_status_display }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ attendance.get_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ attendance.reason|default:"-" }}</td>
                                <td>{{ attendance.recorded_by.get_full_name|default:attendance.recorded_by.email }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Aucune donnée de présence/absence enregistrée pour cet élève.</p>
            {% endif %}
        </div>
    </div>

    ---

    {# --- NOUVELLE SECTION : Historique des Paiements --- #}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h4 class="mb-0">Historique des Paiements</h4>
        </div>
        <div class="card-body">
            {% if payments %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Date du Paiement</th>
                                <th>Montant</th>
                                <th>Méthode</th>
                                <th>Description</th>
                                <th>Enregistré par</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                            <tr>
                                <td>{{ payment.date|date:"d/m/Y H:i" }}</td>
                                <td><span class="badge bg-success">{{ payment.amount }}</span></td>
                                <td>{{ payment.get_payment_method_display }}</td>
                                <td>{{ payment.description|default:"-" }}</td>
                                <td>{{ payment.recorded_by.get_full_name|default:payment.recorded_by.email }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Aucun paiement enregistré pour cet élève.</p>
            {% endif %}
        </div>
    </div>
    {# --- Fin NOUVELLE SECTION : Historique des Paiements --- #}

   {# <a href="{% url 'edit_student' student.id %}" class="btn btn-warning mt-3">Modifier le Profil de l'Élève</a>#}

</div>
{% endblock %}